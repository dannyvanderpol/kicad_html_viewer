"use strict";(()=>{var Logger=class{LEVEL_SYSTEM=1;LEVEL_EVENTS=2;LEVEL_TIMER=4;LEVEL_VIEWER=8;LEVEL_PARSER=16;LEVEL_DRAWER=32;logBuffer=[];logElement=null;logLevel=this.LEVEL_SYSTEM|this.LEVEL_VIEWER|this.LEVEL_TIMER;constructor(){}info(logLevel,...args){this._addToBuffer(logLevel,"INFO ",...args)}warn(logLevel,...args){this._addToBuffer(logLevel,"WARN ",...args)}error(logLevel,...args){console.error(...args);this._addToBuffer(logLevel,"ERROR",...args)}setLogElement(elementId){const element=document.getElementById(elementId);if(element){this.logElement=element;document.getElementById("btnClear").addEventListener("click",()=>{logger.clearLogs()});document.getElementById("btnDownload").addEventListener("click",()=>{logger.downloadLogs("kicad_viewer_logs.txt")})}}_addToBuffer(logLevel,level,...args){const timestamp=new Date().toISOString();const message=args.map(arg=>typeof arg==="object"?JSON.stringify(arg,null,2):String(arg)).join(" ");const logLine=`[${timestamp}] [${level}] ${message}`;this.logBuffer.push(logLine);if(this.logElement&&this.logLevel&logLevel){setTimeout(()=>{let textClass="info";if(logLine.includes("[WARN"))textClass="warn";if(logLine.includes("[ERROR"))textClass="error";this.logElement.innerHTML+=`<span class="${textClass}">${logLine}</span>
`;this.logElement.scrollTop=this.logElement.scrollHeight},0)}}downloadLogs(filename="logs.txt"){const content=this.logBuffer.join("\n");const blob=new Blob([content],{type:"text/plain"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url)}clearLogs(){this.logBuffer=[];if(this.logElement){this.logElement.textContent=""}}};var logger=new Logger;var Timer=class{#timers={};constructor(){}reset(){this.#timers={}}start(label){this.#timers[label]??=[];this.#timers[label].push(performance.now())}stop(label){if(this.#timers[label]!==void 0){const startTime=this.#timers[label].pop();const elapsed=performance.now()-startTime;this.#timers[label].push(elapsed)}}showReport(){const lines=[];let maxLabelLength=0;for(const[label,times]of Object.entries(this.#timers)){if(label.length>maxLabelLength)maxLabelLength=label.length}maxLabelLength++;lines.push("Timer results:");let hLine="+"+"-".repeat(maxLabelLength+1)+("+"+"-".repeat(11)).repeat(4)+"+";lines.push(hLine);let line="| label".padEnd(maxLabelLength+2," ")+"| Calls (#) | Avg (ms)  | Min (ms)  | Max (ms)  |";lines.push(line);lines.push(hLine);for(const[label,times]of Object.entries(this.#timers)){const total=times.reduce((a,b)=>a+b,0);line="| "+label.padEnd(maxLabelLength)+"|";line+=" "+times.length.toString().padEnd(10," ")+"|";line+=" "+(total/times.length).toFixed(1).padEnd(10," ")+"|";line+=" "+Math.min(...times).toFixed(1).padEnd(10," ")+"|";line+=" "+Math.max(...times).toFixed(1).padEnd(10," ")+"|";lines.push(line)}lines.push(hLine);for(line of lines){logger.info(logger.LEVEL_TIMER,line)}}};var timer=new Timer;var KI_FONT=new Uint8Array([119,79,70,50,0,1,0,0,0,0,26,220,0,14,0,0,0,0,59,52,0,0,26,128,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,63,70,70,84,77,28,26,38,6,96,0,130,66,8,4,17,8,10,227,104,201,32,11,129,70,0,1,54,2,36,3,131,8,4,32,5,133,56,7,129,102,27,47,44,51,3,193,198,1,160,12,242,62,217,127,145,192,27,82,255,104,129,152,146,120,105,163,98,17,39,44,194,207,18,59,187,166,222,13,123,248,37,69,56,239,250,65,39,248,6,38,156,8,27,33,201,236,240,188,219,254,207,101,137,121,69,16,46,142,133,224,189,112,113,97,34,136,89,145,130,41,130,22,130,131,114,65,216,216,92,71,150,45,199,170,45,182,223,42,172,23,79,94,203,222,48,27,235,251,74,205,55,166,65,189,255,108,76,123,83,223,48,229,129,239,112,255,70,99,147,70,113,32,97,97,224,105,155,3,108,27,36,20,245,124,131,116,84,193,109,110,31,66,8,61,17,237,62,183,124,22,194,23,136,217,235,237,76,154,168,0,17,219,217,1,46,170,189,40,45,215,2,123,210,70,127,215,155,84,5,147,115,153,76,54,22,74,246,159,165,218,216,120,76,108,34,204,35,165,125,0,18,126,68,114,231,169,243,175,211,92,165,192,1,177,15,166,203,50,220,21,120,237,180,125,125,176,190,244,35,147,28,82,136,20,187,96,8,248,236,130,45,39,125,62,39,5,134,177,119,147,228,144,124,108,231,24,247,78,29,59,222,212,110,67,135,97,232,13,227,214,101,185,196,42,84,15,138,108,71,51,8,214,231,126,246,191,108,230,165,189,219,198,206,132,215,135,6,15,17,135,252,66,219,169,174,4,0,64,1,224,182,99,22,175,249,229,190,40,73,125,243,43,214,10,6,0,87,56,18,72,73,229,124,35,5,0,164,114,232,208,148,56,15,123,81,1,210,46,246,1,96,231,54,2,122,72,24,169,89,19,53,185,123,32,228,164,22,124,234,37,224,26,158,45,199,43,125,192,116,191,5,94,253,74,210,58,237,97,188,140,66,126,100,161,104,33,0,169,12,202,46,164,224,45,166,160,104,91,254,233,246,244,127,185,190,168,188,6,170,142,168,66,145,107,131,237,11,32,128,156,43,213,26,232,57,225,207,121,32,244,63,216,145,124,65,20,138,9,69,184,56,58,38,54,46,94,146,48,51,81,154,36,147,39,43,82,102,165,206,158,51,87,57,47,45,93,165,206,152,159,153,165,201,214,234,114,114,23,44,212,231,25,140,249,5,133,69,166,69,139,139,75,74,203,202,193,217,138,200,106,53,66,165,72,94,106,230,111,113,45,125,252,158,0,251,217,242,76,119,156,126,24,233,94,35,163,234,218,24,101,35,37,10,185,45,206,144,126,4,165,187,38,247,187,10,161,58,35,114,4,13,169,167,77,206,20,76,38,12,167,82,10,181,25,112,32,93,29,123,57,242,131,165,82,65,40,7,102,194,169,156,168,196,57,145,106,21,147,165,103,50,173,176,92,97,14,11,134,217,82,102,37,35,152,44,153,49,67,21,128,195,131,178,66,225,208,80,86,68,176,132,41,152,161,136,136,246,53,224,24,118,100,40,194,229,194,220,74,61,25,150,192,82,157,87,66,23,169,96,148,9,51,3,67,57,179,49,9,51,234,129,35,84,34,172,233,76,35,184,114,88,30,42,79,170,92,87,195,84,89,185,225,146,12,191,27,102,169,38,28,203,174,68,255,30,5,248,12,15,121,130,142,4,92,31,13,165,2,30,51,159,133,196,249,74,18,189,129,194,84,69,238,198,32,9,198,26,77,137,119,42,213,134,142,141,59,185,14,119,145,234,229,135,93,136,36,88,108,8,60,199,83,37,202,20,177,219,39,186,230,162,38,89,31,120,196,25,15,71,116,167,230,105,10,53,91,197,165,44,72,100,171,4,84,169,39,160,6,229,98,38,185,0,18,71,207,115,61,174,255,45,153,227,72,37,14,104,106,145,132,144,141,234,109,32,168,115,241,60,201,197,140,112,146,54,46,75,253,105,198,190,225,23,175,126,240,9,148,13,234,97,250,20,96,1,101,21,27,185,14,137,100,255,96,58,53,112,80,167,221,112,196,177,112,34,22,57,202,13,197,208,40,196,145,56,238,247,33,197,198,49,208,245,0,57,110,160,171,157,77,20,47,75,71,36,99,92,115,200,141,190,22,219,55,62,11,25,142,55,20,45,35,192,124,36,35,134,48,75,241,7,240,237,66,90,218,23,135,85,79,49,28,161,25,74,5,128,44,68,125,86,19,186,144,89,4,172,228,232,25,144,204,68,14,85,35,99,164,121,174,212,173,12,17,100,157,68,40,226,51,80,219,7,21,14,215,227,152,71,36,140,229,88,44,48,145,7,249,72,99,165,216,113,63,86,170,208,137,49,207,230,78,232,147,44,72,36,171,4,136,243,125,75,36,37,118,34,86,6,120,227,157,92,104,131,206,31,166,75,30,29,69,226,60,241,21,106,18,58,155,107,141,110,201,202,63,252,206,66,67,79,34,48,242,69,76,26,170,52,190,244,250,78,70,191,225,90,166,195,50,37,26,142,234,81,140,72,148,0,90,100,140,10,48,174,183,9,39,145,176,137,152,17,150,21,200,22,169,18,26,127,76,182,177,62,108,102,131,248,50,162,71,222,168,251,117,29,104,109,117,128,86,162,71,232,77,154,162,245,169,9,142,179,127,33,119,81,93,177,19,162,157,140,89,4,45,32,91,221,175,251,35,64,114,117,163,88,235,122,131,134,97,170,110,99,172,192,184,90,183,105,111,85,47,171,67,35,218,223,16,237,229,104,4,194,34,50,20,18,9,145,253,169,90,132,82,28,98,175,192,53,83,213,169,152,94,72,6,149,35,50,55,54,20,27,147,234,171,156,213,186,151,67,166,228,6,63,5,140,145,106,105,190,47,82,116,19,202,24,103,76,205,208,59,136,125,65,207,71,65,156,31,209,125,48,24,30,37,219,127,232,203,246,51,155,166,206,173,164,66,19,199,36,79,156,159,116,10,111,239,248,246,247,75,116,247,133,7,247,248,155,187,103,222,39,118,111,217,145,255,194,143,179,24,62,127,26,102,178,77,160,118,16,208,226,143,100,28,66,100,153,4,8,236,181,134,112,237,191,225,157,197,168,210,167,238,183,218,222,10,63,136,166,166,87,145,44,30,161,141,3,65,217,139,167,60,68,35,190,14,26,41,223,60,129,29,157,15,16,97,244,186,19,162,194,115,12,165,34,27,143,4,202,245,254,212,98,181,180,52,30,54,109,228,112,139,159,168,246,205,108,49,244,146,55,139,180,157,195,9,215,8,11,162,241,231,49,150,41,154,29,133,189,118,166,208,229,64,184,239,21,80,49,206,165,98,94,70,30,200,45,65,144,7,162,103,99,112,41,167,209,14,220,170,81,113,13,10,125,171,172,53,153,136,138,56,153,220,98,96,24,22,214,32,139,17,70,191,255,156,174,247,3,76,42,29,32,9,21,254,114,35,183,114,216,70,173,147,128,130,85,135,245,75,181,195,55,127,116,188,34,78,220,89,12,231,28,128,55,76,198,171,241,72,59,251,218,63,40,167,198,67,235,112,185,191,146,217,199,185,23,140,202,196,42,240,234,128,236,118,178,89,18,150,237,174,85,85,159,200,172,116,245,43,244,20,155,228,194,40,218,59,50,146,36,88,153,4,131,117,207,50,21,97,101,28,176,134,18,91,53,252,35,173,63,96,86,221,133,64,100,52,18,105,87,57,172,108,232,230,89,250,40,114,132,56,108,79,28,9,91,149,218,50,21,70,166,29,1,169,137,12,53,104,6,84,197,210,91,181,173,48,242,134,69,20,121,158,27,197,170,0,155,16,31,17,192,7,237,1,47,205,236,204,15,30,158,61,152,155,100,31,131,29,170,180,134,202,93,200,84,4,26,177,5,70,146,225,21,20,166,226,141,38,230,198,86,117,54,104,24,151,94,77,56,244,186,146,247,22,170,79,170,76,11,139,15,0,153,249,34,100,65,12,80,192,64,77,99,218,48,69,101,38,208,191,174,96,227,253,251,162,27,250,15,43,203,65,67,39,116,204,101,91,189,219,141,238,21,4,132,204,5,229,67,44,212,230,14,221,1,185,242,83,181,33,189,14,188,90,236,64,78,63,165,31,125,205,37,159,48,24,226,50,191,134,77,184,146,97,48,239,223,207,130,115,184,12,128,248,8,133,82,119,151,197,197,55,66,85,212,32,201,13,40,26,41,239,65,107,81,239,203,8,217,126,4,173,114,70,222,177,119,85,123,60,240,245,65,233,161,249,80,236,183,117,230,214,220,118,47,6,64,101,41,92,166,133,90,50,141,33,159,229,96,208,33,153,182,193,154,131,129,65,179,12,202,170,215,124,219,66,22,33,224,156,34,47,56,240,173,31,246,86,147,201,107,128,215,103,4,112,82,36,141,227,182,152,180,167,155,23,177,42,211,248,234,210,76,107,52,162,214,37,53,67,98,22,233,53,115,144,97,50,34,100,168,38,34,130,133,193,2,198,190,186,50,196,239,138,108,16,216,170,230,242,231,165,56,139,90,79,162,118,68,240,103,117,95,34,19,162,238,220,129,125,53,69,147,47,164,236,180,44,14,147,97,215,217,113,8,66,17,59,189,52,43,160,108,112,184,227,219,34,235,185,33,28,244,177,118,249,136,79,38,157,103,237,179,33,97,109,232,246,170,47,56,80,52,85,153,250,16,215,142,68,9,70,238,46,136,44,250,154,37,213,77,90,23,212,193,252,79,206,104,38,66,107,136,46,8,251,162,29,169,79,118,71,249,205,162,114,86,27,120,209,171,139,130,170,207,186,150,230,181,4,135,119,52,249,51,66,33,140,173,7,55,117,179,146,239,141,188,42,203,4,176,62,211,91,160,116,70,189,210,48,203,217,32,246,16,160,160,38,144,198,20,124,95,17,210,161,253,105,70,71,22,116,226,224,6,123,248,93,160,106,114,148,224,141,99,31,89,243,139,71,6,180,59,190,166,214,157,93,245,125,9,241,8,22,157,202,54,199,100,191,100,156,193,231,18,82,3,47,60,56,152,150,78,92,83,151,109,188,239,113,233,157,154,158,153,143,140,91,115,116,231,198,185,1,169,103,207,95,253,48,184,234,129,39,173,213,125,145,227,147,211,0,68,30,241,62,242,148,215,95,216,31,231,69,222,54,38,30,51,2,46,118,143,124,71,116,135,236,34,185,64,122,74,252,58,31,67,110,70,203,7,180,63,126,13,156,98,109,102,157,122,174,151,6,8,83,8,93,95,128,52,92,160,197,206,77,124,217,38,127,59,247,6,55,44,94,250,50,219,191,70,80,227,95,28,115,39,155,213,202,111,101,149,200,39,37,215,185,161,146,196,23,109,55,49,60,233,11,45,107,108,3,127,3,10,171,23,182,8,90,192,51,143,92,6,104,155,212,1,243,93,46,72,159,177,76,230,181,112,26,65,25,187,142,253,105,134,197,147,39,134,9,111,244,170,105,21,58,149,172,204,109,38,255,209,96,161,127,211,48,131,59,96,213,8,106,26,103,208,202,231,252,57,85,145,50,209,207,78,229,165,79,75,43,102,206,80,54,50,11,42,157,154,53,77,92,137,35,176,215,100,19,179,206,104,42,211,175,120,3,211,199,219,232,54,163,1,226,251,181,136,157,244,162,107,88,7,126,182,211,187,208,219,136,135,127,133,86,46,210,162,19,107,48,109,215,201,107,187,53,19,90,204,180,98,187,167,91,80,237,197,79,114,111,121,58,75,47,196,8,139,76,110,89,225,46,229,159,148,124,66,159,4,207,10,19,147,198,187,74,78,210,241,42,91,153,204,66,96,24,1,216,127,180,219,97,33,236,40,112,79,188,186,172,55,205,114,58,102,180,10,102,230,207,45,232,189,107,91,121,22,53,226,22,15,34,58,122,0,70,4,168,43,211,211,93,33,200,160,120,8,105,31,107,49,188,25,101,241,243,13,22,30,230,128,43,97,187,46,10,203,55,202,80,173,9,208,34,119,32,185,209,152,152,160,20,251,75,185,40,129,121,235,200,94,207,53,227,105,60,109,226,224,136,223,126,220,15,223,175,32,143,245,15,222,93,124,215,233,90,236,242,172,62,247,45,196,2,140,196,235,183,222,58,138,63,238,98,160,252,128,41,216,146,24,126,184,53,33,123,123,80,118,208,54,107,144,163,219,111,117,173,135,195,145,99,113,70,250,39,45,128,160,46,136,20,188,128,4,5,55,83,200,171,52,224,56,13,56,133,50,227,251,71,58,15,3,242,133,117,170,48,167,147,213,144,135,56,210,74,18,101,21,121,6,9,42,135,90,252,157,167,195,230,200,195,173,51,179,183,7,106,71,162,219,28,221,126,59,253,150,35,128,65,254,34,216,223,87,163,9,239,169,109,61,216,147,203,123,88,171,152,219,80,251,224,193,242,142,185,138,218,135,82,239,57,120,104,121,79,225,239,213,248,130,237,207,197,3,156,137,41,50,128,15,32,83,19,120,80,60,152,57,119,240,186,53,165,33,56,158,81,39,45,206,172,206,73,72,33,18,19,250,69,243,121,193,32,174,86,102,8,246,15,54,60,143,7,14,222,77,140,120,201,148,48,95,70,196,246,64,156,247,225,249,242,119,4,23,138,222,229,94,40,219,45,184,233,79,7,176,137,45,14,223,60,95,71,30,106,177,54,25,101,120,118,20,5,63,72,165,93,165,81,133,135,18,117,143,150,27,154,172,132,30,173,95,160,71,137,71,96,144,199,212,36,79,222,141,71,119,158,211,109,241,119,39,21,201,236,29,231,239,73,0,17,44,127,134,51,191,115,113,250,68,151,56,247,33,50,116,159,115,73,212,199,113,165,42,149,106,115,86,84,224,98,246,237,192,121,60,165,50,99,249,46,192,248,102,171,29,190,1,59,180,40,161,182,26,228,104,118,17,172,245,198,48,155,184,165,150,216,140,184,197,110,100,130,185,87,119,175,186,255,90,68,105,242,157,222,110,103,183,223,152,216,45,126,109,53,90,0,133,156,46,246,32,83,124,103,97,255,207,20,95,123,14,102,54,86,171,101,152,214,4,95,135,77,152,86,166,174,54,154,115,48,187,239,75,216,129,151,43,58,141,58,229,119,249,155,203,189,35,167,71,122,47,47,63,187,128,93,8,96,157,176,205,242,95,120,236,167,63,6,56,78,204,201,25,72,101,59,133,78,118,106,230,207,157,24,120,210,122,150,171,7,180,134,5,254,63,113,218,185,110,220,205,93,20,240,112,170,203,247,54,220,149,19,69,168,171,12,114,76,99,242,185,12,23,97,217,50,99,149,138,200,65,29,240,109,95,123,14,74,24,172,99,184,59,122,204,111,208,213,215,251,227,201,159,62,239,115,13,250,245,254,233,254,47,28,176,79,212,57,224,163,136,27,247,32,123,186,221,234,10,142,62,157,215,9,31,131,59,117,168,77,109,53,202,48,109,22,124,21,214,16,51,177,170,9,29,250,45,253,216,255,205,188,148,56,231,108,13,124,5,130,214,123,33,232,65,145,76,103,19,240,43,12,196,66,247,169,17,103,119,99,183,115,228,212,79,113,44,32,91,82,113,55,194,11,61,166,134,140,70,218,182,46,248,203,54,119,228,27,4,48,5,181,14,248,24,236,24,104,134,65,30,204,130,49,56,107,148,78,136,201,132,242,37,135,116,185,193,106,180,180,144,166,132,174,136,71,27,146,47,199,10,82,19,235,118,247,157,30,217,246,147,179,175,177,207,249,211,182,145,211,125,75,60,207,144,26,49,158,113,25,0,195,82,219,233,179,31,238,204,68,205,106,181,74,46,208,104,224,62,8,90,79,163,70,29,8,148,101,174,139,226,143,212,140,231,181,195,251,57,125,120,31,167,165,174,79,105,101,47,252,25,122,125,236,245,118,198,36,35,22,149,157,5,95,134,53,81,26,161,1,152,153,23,230,156,252,188,173,110,83,221,225,207,61,127,196,186,29,52,255,16,61,93,243,38,230,77,205,116,252,162,137,16,197,112,69,79,109,24,203,205,152,94,10,168,21,56,112,85,236,49,190,22,191,54,122,252,140,49,220,50,241,162,120,16,193,124,52,168,70,102,76,208,193,209,116,250,142,133,128,150,109,93,55,199,235,63,86,38,227,55,187,30,142,63,185,127,52,237,168,28,101,28,136,152,73,198,96,255,96,227,243,235,80,48,3,77,101,150,91,241,84,244,167,219,19,225,19,183,93,40,53,254,214,31,180,158,110,101,65,3,51,46,180,59,224,235,176,253,255,20,1,166,166,131,53,14,202,85,4,213,124,231,221,16,71,87,132,193,207,107,180,196,119,113,36,105,63,126,58,141,23,180,57,170,95,116,244,236,34,118,71,34,210,63,188,121,179,75,180,189,170,78,223,84,168,223,180,139,53,236,187,72,164,223,234,165,199,29,190,98,238,20,159,111,36,244,162,139,190,121,190,93,122,17,145,127,200,40,199,245,217,128,106,92,157,220,120,24,159,137,59,142,169,7,127,32,224,78,115,243,70,15,209,86,124,122,62,221,186,34,99,143,64,181,174,204,200,88,233,2,123,50,86,172,156,159,45,138,208,69,127,218,180,41,166,78,95,185,189,11,103,173,63,137,111,175,220,52,162,77,93,65,160,168,43,53,85,116,50,176,64,191,169,176,248,7,208,87,109,231,51,7,5,83,138,169,193,55,138,55,131,211,138,105,160,119,236,138,220,95,114,85,73,2,218,199,121,81,171,245,121,243,110,41,148,183,44,105,155,163,44,217,143,1,233,154,50,39,55,238,175,218,181,128,218,97,66,134,16,198,210,208,171,194,136,97,90,141,114,250,96,198,193,250,19,45,104,1,1,155,60,50,35,144,205,203,70,1,73,200,32,178,164,42,125,220,229,28,89,116,191,166,44,130,188,228,243,244,146,70,156,174,225,48,16,240,77,187,141,174,163,219,8,236,120,171,113,76,236,17,143,121,74,35,102,151,67,30,240,148,252,93,203,52,112,158,7,101,16,72,230,193,63,107,108,61,78,96,109,125,90,45,237,56,14,130,30,70,104,149,180,23,153,195,3,72,129,6,13,80,9,30,165,235,231,142,232,137,22,173,206,32,92,192,65,143,204,36,188,56,78,137,46,178,229,4,129,173,167,95,231,173,126,226,118,51,197,205,130,221,75,5,187,99,1,181,163,24,25,66,234,17,57,186,27,201,13,187,143,184,197,30,228,126,122,110,86,170,111,7,217,149,23,138,57,158,39,12,225,67,180,74,8,238,159,0,220,63,218,109,244,74,184,83,139,226,255,67,234,68,243,120,101,2,205,26,43,173,159,234,95,214,158,30,17,159,20,194,64,36,179,162,17,123,196,30,206,130,229,11,56,30,207,196,212,124,85,203,169,190,96,8,17,115,0,117,116,79,25,76,71,6,126,179,7,119,35,233,123,248,209,82,106,180,186,150,19,4,106,163,235,68,200,165,46,141,24,140,40,157,133,0,26,187,121,113,198,154,154,49,241,16,254,96,214,172,185,31,93,43,12,108,188,38,127,207,153,49,4,34,200,9,0,85,255,206,61,56,240,214,35,241,158,8,160,228,181,7,76,111,125,248,122,106,235,116,199,74,214,120,33,234,110,155,71,233,49,149,234,94,39,207,2,148,155,109,129,175,118,175,109,92,197,241,136,135,56,98,127,13,253,237,150,181,13,43,171,34,88,228,118,7,124,196,157,34,204,70,173,246,240,108,105,103,50,188,218,83,15,107,117,107,15,92,3,40,184,199,30,138,197,14,83,189,24,52,170,163,177,220,68,107,52,175,77,118,185,121,205,144,110,118,187,234,119,26,32,141,90,197,155,228,243,64,179,169,43,28,146,215,112,154,13,114,67,133,218,214,110,135,73,185,99,95,14,235,133,241,110,231,192,162,187,78,215,56,96,158,104,182,251,236,245,177,207,23,88,12,243,231,183,198,8,246,32,180,73,42,226,172,98,90,173,144,50,34,176,135,148,29,128,55,169,166,189,38,229,170,197,212,73,26,184,199,168,44,210,14,79,120,221,111,58,120,120,69,237,198,182,221,216,109,27,107,37,173,43,102,179,47,9,47,177,51,135,142,3,228,188,60,100,8,73,2,24,55,113,64,53,211,199,36,128,131,19,90,212,14,179,191,155,121,118,89,64,243,217,169,85,149,11,116,150,176,164,103,23,4,45,237,118,30,76,181,142,3,134,101,179,185,230,93,78,96,178,168,31,210,100,43,5,221,151,211,92,210,111,42,35,236,168,114,222,74,77,209,77,68,143,193,146,80,237,240,116,208,100,156,254,214,115,92,174,32,207,30,165,76,91,212,107,140,24,216,229,195,140,21,106,27,32,159,200,196,61,200,61,196,99,213,158,9,117,21,54,209,131,0,106,71,187,216,141,52,142,56,93,245,46,231,72,35,50,8,220,123,105,136,214,18,195,131,180,183,62,180,161,185,46,205,236,57,172,172,205,105,117,168,153,57,42,206,61,206,59,158,235,79,215,12,40,228,182,54,84,181,191,194,186,77,233,224,247,72,42,182,237,171,80,161,109,121,233,48,89,44,185,248,165,86,185,172,157,29,131,178,135,223,37,129,217,226,116,64,97,19,88,203,185,81,35,217,254,131,131,220,182,179,255,110,8,156,109,13,56,244,126,1,124,248,133,27,80,44,160,252,81,39,171,61,251,203,18,158,112,182,86,214,250,1,245,8,193,58,37,184,252,129,72,57,196,110,36,52,252,150,247,147,145,203,243,79,76,98,0,233,155,98,102,5,235,192,21,21,89,193,92,155,180,54,246,28,96,69,54,128,44,232,60,143,188,43,184,89,180,187,236,2,151,70,95,40,122,7,144,70,181,53,224,226,26,147,219,219,2,63,203,190,145,168,145,227,181,240,202,227,23,225,250,114,149,23,190,120,124,37,12,4,5,73,198,16,86,136,58,73,109,115,3,242,205,179,167,208,251,75,75,6,4,7,177,151,211,2,189,203,236,62,123,124,236,25,81,63,172,22,100,105,124,178,32,72,8,1,148,115,73,56,20,152,228,206,239,49,63,234,251,53,252,172,44,120,106,225,107,86,127,127,7,72,190,83,51,121,235,159,214,62,160,103,147,63,161,11,25,9,251,93,157,88,159,184,238,239,99,9,128,66,236,18,123,144,95,34,205,160,60,53,44,132,101,132,63,112,208,152,216,141,96,16,52,4,65,137,136,117,233,62,189,57,229,97,179,94,1,240,180,190,211,103,135,79,147,26,163,127,74,77,165,159,171,42,222,232,252,202,185,177,184,234,172,247,108,202,167,222,106,180,169,208,210,169,66,45,178,24,149,144,175,213,192,207,225,44,190,14,83,99,106,51,8,19,4,19,38,29,178,15,138,120,196,99,65,76,60,34,66,85,72,228,40,103,153,190,254,242,145,145,225,145,35,151,235,245,96,160,181,43,165,118,233,78,92,142,79,3,231,248,175,34,153,212,21,29,138,250,180,72,81,29,250,67,144,14,173,155,141,62,45,242,40,0,73,88,131,233,214,60,225,255,24,166,8,236,72,174,79,238,0,108,88,97,186,112,69,231,117,169,139,119,239,212,221,207,189,32,228,249,60,100,72,60,136,141,178,12,46,66,117,91,158,128,199,203,89,104,18,189,198,117,161,28,222,239,99,119,158,89,233,227,19,245,3,121,223,200,197,46,231,72,106,130,56,104,154,137,8,45,121,159,9,188,191,215,172,67,70,85,132,103,220,222,202,17,232,180,173,93,87,4,127,200,64,255,99,245,138,69,46,214,231,1,86,165,17,39,198,201,143,62,233,143,94,138,234,128,189,186,0,38,118,143,197,76,53,141,225,99,77,111,99,94,55,77,225,83,242,239,98,38,145,143,225,34,81,246,150,167,11,81,135,175,136,251,74,252,138,27,90,120,252,248,222,9,210,60,181,59,30,207,152,120,80,60,214,255,197,32,243,90,97,96,211,240,77,170,234,107,64,247,54,180,239,113,206,250,7,120,63,167,78,196,23,132,139,162,63,65,64,50,5,228,32,67,92,158,251,169,3,174,130,29,58,172,113,105,129,29,60,96,10,158,146,82,93,13,235,38,48,240,253,14,69,49,222,241,126,178,192,197,186,114,224,232,33,4,164,248,130,92,228,1,18,233,153,232,130,171,141,184,98,98,11,150,235,185,192,45,36,122,184,167,236,138,146,203,254,183,147,99,4,147,205,14,184,6,118,228,8,205,198,165,6,185,80,167,129,95,193,26,167,203,13,75,141,230,4,194,47,210,9,109,11,49,157,105,182,9,51,179,173,87,12,57,239,127,227,118,14,21,251,5,47,191,125,249,66,160,136,70,17,15,62,134,155,69,53,26,1,80,160,36,176,58,61,45,58,97,20,113,227,110,196,59,227,150,156,49,215,119,59,71,190,52,84,151,5,76,108,158,19,243,60,28,183,103,30,165,117,223,239,168,109,1,238,125,110,123,213,64,210,57,18,116,24,185,204,241,239,37,179,152,243,209,78,56,147,227,18,187,56,179,235,218,123,107,144,110,81,31,2,190,88,111,247,89,179,74,206,29,244,9,165,56,232,203,2,111,27,195,230,109,206,181,253,176,69,160,93,165,83,141,171,184,229,251,76,180,211,103,191,79,231,232,129,253,156,197,244,159,235,254,182,249,217,254,177,52,89,181,38,42,91,3,104,96,205,15,192,231,155,101,89,117,239,14,99,193,221,43,234,21,243,118,76,231,105,209,91,81,109,22,92,157,230,232,52,173,193,22,172,94,31,59,137,28,56,87,107,121,203,187,128,76,198,133,218,126,40,219,223,155,3,4,247,101,14,223,205,190,61,121,232,248,22,60,219,4,127,128,0,83,254,177,117,182,67,219,15,109,183,173,219,41,48,15,128,156,179,252,179,57,3,192,6,242,244,189,245,250,45,85,171,159,21,15,243,135,139,215,60,219,92,165,175,191,187,80,239,252,47,231,134,228,225,234,234,201,234,201,213,15,37,231,115,62,250,79,15,226,83,189,58,134,157,119,63,186,59,220,224,165,30,238,117,247,122,238,101,120,53,222,251,104,192,57,112,207,238,37,187,210,235,233,117,95,5,249,133,43,75,203,246,46,219,187,172,172,116,19,171,236,218,67,8,210,58,147,43,202,13,102,109,164,104,19,243,166,80,21,126,96,222,190,207,135,203,192,44,68,56,192,121,55,220,33,44,238,78,230,12,32,46,130,47,57,19,224,59,90,66,208,67,252,164,97,82,63,118,2,155,70,199,186,100,170,116,89,23,230,77,149,168,44,36,132,78,152,236,166,200,140,78,99,95,20,197,224,23,217,84,239,10,64,115,1,202,104,19,175,130,213,200,172,224,5,241,124,128,52,26,23,166,98,132,120,91,76,14,77,151,172,183,167,75,17,173,232,170,180,144,117,105,28,38,139,119,8,67,85,82,217,9,133,118,44,93,133,53,0,71,161,12,240,49,200,202,218,144,122,209,227,17,58,133,30,190,209,156,33,200,82,212,194,253,29,18,94,194,60,137,42,51,184,179,235,64,32,62,245,188,23,5,188,158,121,142,70,117,191,103,146,73,32,85,66,46,161,130,76,45,13,154,12,12,194,145,207,40,251,203,99,214,82,109,169,95,234,95,244,8,242,179,207,73,11,65,166,126,174,14,119,61,249,103,1,160,35,125,6,23,253,33,126,166,150,160,0,11,169,119,65,243,86,137,108,118,166,35,128,116,0,160,62,69,24,67,191,75,110,14,252,182,154,127,117,102,205,225,115,102,16,183,170,80,232,3,249,55,91,210,110,90,124,207,196,207,66,221,127,164,215,157,201,234,148,180,243,21,219,159,148,29,145,210,239,230,118,92,82,111,201,26,160,169,141,98,179,41,183,144,225,40,138,238,25,220,7,229,109,52,103,211,195,163,238,57,118,229,185,180,61,81,208,81,69,29,178,168,191,204,233,103,26,47,41,155,39,165,175,164,167,33,237,149,184,250,200,251,155,114,31,88,222,12,169,185,36,229,16,195,207,62,165,27,82,143,79,125,118,226,99,83,156,72,198,81,204,92,182,216,131,68,203,51,35,105,216,61,19,53,213,179,51,79,34,107,1,188,92,170,74,37,182,212,172,88,98,203,32,105,14,233,132,100,199,102,72,184,217,225,41,183,139,34,85,217,254,144,244,138,164,212,32,109,199,200,226,151,54,196,16,83,184,174,227,50,207,9,249,181,83,173,161,238,19,137,179,193,245,147,111,185,184,56,196,86,217,108,86,143,10,109,87,2,121,128,146,19,59,65,15,115,110,27,53,14,36,14,136,183,191,28,36,94,161,231,32,139,90,185,131,194,59,236,29,84,126,225,22,74,195,218,223,200,96,102,110,52,218,1,228,128,248,251,191,131,132,97,218,65,150,185,0,7,133,255,154,29,84,225,115,156,41,13,127,223,74,183,214,58,181,108,150,91,106,153,74,60,34,22,184,175,155,73,114,213,73,197,4,171,141,172,202,173,177,82,149,173,139,179,4,74,213,62,154,167,194,90,107,250,72,230,152,173,202,232,75,17,120,84,8,18,175,121,195,114,22,229,144,40,34,14,212,246,235,16,82,196,39,215,72,113,141,191,101,179,20,14,252,87,55,124,22,252,119,32,206,185,209,90,190,102,101,213,154,184,37,214,234,184,47,134,73,250,116,126,125,229,114,75,249,18,145,242,135,56,161,52,252,92,230,2,112,0,114,88,213,32,84,178,89,107,165,144,193,231,158,182,86,218,214,174,156,37,61,28,111,169,42,171,148,179,1,63,242,178,17,128,12,129,148,12,134,152,85,21,219,199,145,224,73,73,67,144,224,180,100,177,143,162,218,100,240,125,251,0,157,196,182,212,202,155,25,39,225,165,240,232,10,193,147,28,171,160,96,67,98,144,207,151,108,5,182,156,161,58,30,137,98,9,140,64,164,128,175,197,209,37,146,132,56,137,72,75,40,107,172,144,34,97,119,172,184,42,201,157,119,122,192,211,34,151,249,211,236,157,159,111,255,159,132,206,219,12,62,96,190,24,252,48,177,248,99,227,64,112,5,8,20,36,88,136,80,97,194,69,224,137,196,39,16,5,133,17,18,193,137,69,139,17,43,78,60,137,4,51,37,146,74,34,35,151,76,33,197,44,169,102,155,99,46,165,121,210,164,83,81,203,48,95,166,44,26,217,180,116,114,228,90,96,225,114,118,121,12,140,242,21,40,84,196,100,145,197,138,149,40,85,166,28,0,0,0]);var Colors={default:"grey",defaultPcbAlpha:.7,kicad_sch:{"background":"rgb(245, 244, 239)","bus":"rgb(0, 0, 132)","junction":"rgb(0, 150, 0)","wire":"rgb(0, 150, 0)","worksheet":"rgb(132, 0, 0)"},kicad_pcb:{"background":"rgb(0, 16, 35)","worksheet":"rgb(200, 114, 171)","cu":{"b":"rgb(77, 127, 196)","f":"rgb(200, 52, 52)","in1":"rgb(127, 200, 127)","in2":"rgb(206, 125, 44)","in3":"rgb(79, 203, 203)","in4":"rgb(219, 98, 139)","in5":"rgb(167, 165, 198)","in6":"rgb(40, 204, 217)","in7":"rgb(232, 178, 167)","in8":"rgb(242, 237, 161)","in9":"rgb(141, 203, 129)","in10":"rgb(237, 124, 51)","in11":"rgb(91, 195, 235)","in12":"rgb(247, 111, 142)","in13":"rgb(167, 165, 198)","in14":"rgb(40, 204, 217)","in15":"rgb(232, 178, 167)","in16":"rgb(242, 237, 161)","in17":"rgb(237, 124, 51)","in18":"rgb(91, 195, 235)","in19":"rgb(247, 111, 142)","in20":"rgb(167, 165, 198)","in21":"rgb(40, 204, 217)","in22":"rgb(232, 178, 167)","in23":"rgb(242, 237, 161)","in24":"rgb(237, 124, 51)","in25":"rgb(91, 195, 235)","in26":"rgb(247, 111, 142)","in27":"rgb(167, 165, 198)","in28":"rgb(40, 204, 217)","in29":"rgb(232, 178, 167)","in30":"rgb(242, 237, 161)"}}};async function fetchFile(filename){timer.start("Fetch file");let content=null;try{const response=await fetch(filename);if(!response.ok){logger.error(logger.LEVEL_SYSTEM,`fetchFile: HTTP error status: ${response.status}`)}else{content=await response.text()}}catch(error){logger.error(logger.LEVEL_SYSTEM,"fetchFile: error loading file:",error)}timer.stop("Fetch file");return content}var PAGE_LAYOUT='(kicad_wks (version 20231118) (generator "pl_editor") (generator_version "9.0") (setup (textsize 1.5 1.5) (linewidth 0.15) (textlinewidth 0.15) (left_margin 10) (right_margin 10) (top_margin 10) (bottom_margin 10)) (rect (name "") (start 110 34) (end 2 2) (comment "rect around the title block")) (rect (name "") (start 0 0 ltcorner) (end 0 0) (repeat 2) (incrx 2) (incry 2)) (line (name "") (start 50 2 ltcorner) (end 50 0 ltcorner) (repeat 30) (incrx 50)) (tbtext "1" (name "") (pos 25 1 ltcorner) (font (size 1.3 1.3)) (repeat 100) (incrx 50)) (line (name "") (start 50 2 lbcorner) (end 50 0 lbcorner) (repeat 30) (incrx 50)) (tbtext "1" (name "") (pos 25 1 lbcorner) (font (size 1.3 1.3)) (repeat 100) (incrx 50)) (line (name "") (start 0 50 ltcorner) (end 2 50 ltcorner) (repeat 30) (incry 50)) (tbtext "A" (name "") (pos 1 25 ltcorner) (font (size 1.3 1.3)) (justify center) (repeat 100) (incry 50)) (line (name "") (start 0 50 rtcorner) (end 2 50 rtcorner) (repeat 30) (incry 50)) (tbtext "A" (name "") (pos 1 25 rtcorner) (font (size 1.3 1.3)) (justify center) (repeat 100) (incry 50)) (tbtext "Date: ${ISSUE_DATE}" (name "") (pos 87 6.9)) (line (name "") (start 110 5.5) (end 2 5.5)) (tbtext "${KICAD_VERSION}" (name "") (pos 109 4.1) (comment "Kicad version")) (line (name "") (start 110 8.5) (end 2 8.5)) (tbtext "Rev: ${REVISION}" (name "") (pos 24 6.9) (font bold)) (tbtext "Size: ${PAPER}" (name "") (pos 109 6.9) (comment "Paper format name")) (tbtext "Id: ${#}/${##}" (name "") (pos 24 4.1) (comment "Sheet id")) (line (name "") (start 110 12.5) (end 2 12.5)) (tbtext "Title: ${TITLE}" (name "") (pos 109 10.7) (font (size 2 2) bold italic)) (tbtext "File: ${FILENAME}" (name "") (pos 109 14.3)) (line (name "") (start 110 18.5) (end 2 18.5)) (tbtext "Sheet: ${SHEETPATH}" (name "") (pos 109 17)) (tbtext "${COMPANY}" (name "") (pos 109 20) (font bold) (comment "Company name")) (tbtext "${COMMENT1}" (name "") (pos 109 23) (comment "Comment 0")) (tbtext "${COMMENT2}" (name "") (pos 109 26) (comment "Comment 1")) (tbtext "${COMMENT3}" (name "") (pos 109 29) (comment "Comment 2")) (tbtext "${COMMENT4}" (name "") (pos 109 32) (comment "Comment 3")) (line (name "") (start 90 8.5) (end 90 5.5)) (line (name "") (start 26 8.5) (end 26 2)))';var KeyValueMap=class{#map={};constructor(){this.#map={"comment1":"","comment2":"","comment3":"","comment4":"","company":"","filename":"","issue_date":"","kicad_version":"","paper":"","revision":"","sheetpath":"/","title":"","#":"","##":""}}set(key,value){this.#map[key]=value}replace(input){return input.replace(/\$\{([^}]+)\}/g,(_,key)=>{if(Object.prototype.hasOwnProperty.call(this.#map,key.toLowerCase())){return this.#map[key.toLowerCase()]}logger.warn(logger.LEVEL_PARSER,`[KeyValueMap] Unknown placeholder: ${key}`);return""})}};var DesignObject=class{constructor(){this.filename="";this.designType="";this.version="";this.designElements=[];this.graphicsElements=[]}getDesignElement(reference){return this.designElements.find(o=>o!=null&&o.reference===reference)}};var Sections={getSections:function(data){let sections=[];let start=-1;let section=0;for(let i=0;i<data.length;i++){if(data[i]=="("){if(section==0){start=i}section+=1}else if(data[i]==")"){section-=1}if(section==0&&start>=0&&i>start){sections.push(data.substring(start,i+1));section=0;start=-1}}return sections},getSectionName:function(section){let name="";for(let i=2;i<section.length;i++){if([" ","\r","\n","	",")"].includes(section[i])){name=section.substring(1,i);break}}return name.trim()},getValues:function(section){section=section.replace(/[\r\n\t]/g," ").replace(/ +/g," ");let values=[];let pos=section.indexOf(" ");if(pos>0){let start=pos;let token="";for(let i=pos;i<section.length-1;i++){if(section[i]==" "&&token==""||section[i]=='"'&&token==" "||section[i]=="("&&token==" "){start=i+1;token=section[i]=="("?")":section[i];continue}if(token!=""&&(section[i]==token||i==section.length-2)){values.push(section.substring(start,i+1).trim().replace(/^"|"$/g,"").replace(/\)$/g,""));if(token==")")token="";start=i+1}}}return values},getProperties:function(sectionContent,singleValue=false){if(typeof sectionContent==="string"){sectionContent=this.getSections(sectionContent.substring(1,sectionContent.length-1))}let properties={};for(const subSection of sectionContent){let value=this.getValues(subSection);let name=this.getSectionName(subSection);if(name=="comment"){name="comment"+value[0];value=[value[1]]}if(singleValue&&value.length>=1){value=value[0]}properties[name]=value}return properties}};var ParserBase=class{constructor(){this.designType=null;this.parentType=null;this.setup=null;this.designElement=null;this.graphicsElements=[]}parseSection(sectionContent,designType,parentType,setup,paper,keyValueMap){this.designType=designType;this.parentType=parentType;this.setup=setup;this.paper=paper;this.keyValueMap=keyValueMap;this.sectionName=Sections.getSectionName(sectionContent);timer.start(`Parse ${this.sectionName}`);this.parse(sectionContent);timer.stop(`Parse ${this.sectionName}`)}parse(sectionContent){console.error("parseSection() not implemented in subclass")}getColor(identifier,overrideColor=[]){if(overrideColor.some(x=>x!==0)){if(overrideColor.length===3){return`rgb(${overrideColor.join(", ")})`}else if(overrideColor.length===4){return`rgba(${overrideColor.join(", ")})`}}let color=Colors.default;let colors=Colors[this.designType];if(this.designType=="kicad_wks"){colors=Colors[this.parentType]}if(colors){let parts=identifier.toLowerCase().split(".");if(parts.length==2){color=colors[parts[1]][parts[0]]||Colors.default;if(color.startsWith("rgb(")){color=color.replace("rgb","rgba").replace(")",`, ${Colors.defaultPcbAlpha})`)}}else{color=colors[identifier]||Colors.default}}else{logger.warn(logger.LEVEL_PARSER,`[ParserBase] No colors for '${this.designType}/${this.parentType}'`)}return color}getLineThickness(thickness=0){if(thickness>0){return thickness}if(this.designType=="kicad_wks"){thickness=this.setup.lineWidth}else{switch(this.sectionName){case"bus":thickness=designDefaults.buswidth;break;case"wire":thickness=designDefaults.lineWidth;break}}return thickness}getTextSize(){return this.setup.textSize}correctXY(axis,value,relativeTo){if(this.designType!="kicad_wks"){return value}switch(relativeTo){case"ltcorner":if(axis=="x"){value+=this.setup.leftMargin}if(axis=="y"){value+=this.setup.topMargin}break;case"rtcorner":if(axis=="x"){value=this.paper.width-this.setup.rightMargin-value}if(axis=="y"){value+=this.setup.topMargin}break;case"lbcorner":if(axis=="x"){value+=this.setup.leftMargin}if(axis=="y"){value=this.paper.height-this.setup.bottomMargin-value}break;case"rbcorner":if(axis=="x"){value=this.paper.width-this.setup.rightMargin-value}else if(axis=="y"){value=this.paper.height-this.setup.bottomMargin-value}break;default:value=this.correctXY(axis,value,"rbcorner")}return value}nextTextSequence(content){if(!isNaN(content)){content=(parseInt(content)+1).toString()}else if(content.length==1){content=String.fromCharCode(content.charCodeAt(0)+1)}else{if(this.showDebug)logger.warn("Drawer: no text sequence for:",content)}return content}};var designDefaults={lineWidth:.1524,buswidth:.3048};var GraphicsBase=class _GraphicsBase{constructor(){this.type=_GraphicsBase.name;this.points=[]}draw(ctx){const name=this.constructor.name;timer.start(`Draw ${name}`);if(this.points.length>=MIN_POINTS[name]){ctx.lineCap="round";ctx.lineJoin="round";this.drawElement(ctx)}else{logger.warn(logger.LEVEL_DRAWER,`[GraphicsBase] Drawing '${name}' skipped`,MIN_POINTS[name])}timer.stop(`Draw ${name}`)}drawElement(ctx,scale){console.error("[GraphicsBase] drawElement() not implemented in subclass")}};var MIN_POINTS={"Junction":1,"Line":2,"Polygon":3,"Rectangle":2,"Text":1};var Line=class extends GraphicsBase{drawElement(ctx){ctx.strokeStyle=this.color;ctx.lineWidth=this.size;if(this.scaledSize){ctx.lineWidth/=this.scale}ctx.beginPath();ctx.moveTo(this.points[0].x,this.points[0].y);ctx.lineTo(this.points[1].x,this.points[1].y);ctx.stroke()}};var BusEntryParser=class extends ParserBase{parse(sectionContent){let properties=Sections.getProperties(sectionContent);const startX=parseFloat(properties.at[0]);const startY=parseFloat(properties.at[1]);const endX=startX+2.54;const endY=startY-2.54;let parts=properties.stroke[0].split(" ");let size=parts[0]=="width"?parseFloat(parts[1]):0;let line=new Line;line.layer="design";line.points.push({x:startX,y:startY});line.points.push({x:endX,y:endY});line.size=this.getLineThickness(size);line.color=this.getColor("wire");this.graphicsElements.push(line)}};var DesignElement=class{constructor(reference){this.reference=reference}};var WorksheetElement=class extends DesignElement{constructor(reference){super(reference);this.filename;this.content}};var ab=ArrayBuffer;var u8=Uint8Array;var u16=Uint16Array;var i16=Int16Array;var i32=Int32Array;var slc=(v,s,e)=>{if(u8.prototype.slice)return u8.prototype.slice.call(v,s,e);if(s==null||s<0)s=0;if(e==null||e>v.length)e=v.length;const n=new u8(e-s);n.set(v.subarray(s,e));return n};var fill=(v,n,s,e)=>{if(u8.prototype.fill)return u8.prototype.fill.call(v,n,s,e);if(s==null||s<0)s=0;if(e==null||e>v.length)e=v.length;for(;s<e;++s)v[s]=n;return v};var cpw=(v,t,s,e)=>{if(u8.prototype.copyWithin)return u8.prototype.copyWithin.call(v,t,s,e);if(s==null||s<0)s=0;if(e==null||e>v.length)e=v.length;while(s<e){v[t++]=v[s++]}};var ec=["invalid zstd data","window size too large (>2046MB)","invalid block type","FSE accuracy too high","match distance too far back","unexpected EOF"];var err=(ind,msg,nt)=>{const e=new Error(msg||ec[ind]);e.code=ind;if(Error.captureStackTrace)Error.captureStackTrace(e,err);if(!nt)throw e;return e};var rb=(d,b,n)=>{let i=0,o=0;for(;i<n;++i)o|=d[b++]<<(i<<3);return o};var b4=(d,b)=>(d[b]|d[b+1]<<8|d[b+2]<<16|d[b+3]<<24)>>>0;var rzfh=(dat,w)=>{const n3=dat[0]|dat[1]<<8|dat[2]<<16;if(n3==3126568&&dat[3]==253){const flg=dat[4];const ss=flg>>5&1,cc=flg>>2&1,df=flg&3,fcf=flg>>6;if(flg&8)err(0);let bt=6-ss;const db=df==3?4:df;const di=rb(dat,bt,db);bt+=db;const fsb=fcf?1<<fcf:ss;const fss=rb(dat,bt,fsb)+(fcf==1&&256);let ws=fss;if(!ss){const wb=1<<10+(dat[5]>>3);ws=wb+(wb>>3)*(dat[5]&7)}if(ws>2145386496)err(1);const buf=new u8((w==1?fss||ws:w?0:ws)+12);buf[0]=1,buf[4]=4,buf[8]=8;return{b:bt+fsb,y:0,l:0,d:di,w:w&&w!=1?w:buf.subarray(12),e:ws,o:new i32(buf.buffer,0,3),u:fss,c:cc,m:Math.min(131072,ws)}}else if((n3>>4|dat[3]<<20)==25481893){return b4(dat,4)+8}err(0)};var msb=val=>{let bits=0;for(;1<<bits<=val;++bits);return bits-1};var rfse=(dat,bt,mal)=>{let tpos=(bt<<3)+4;const al=(dat[bt]&15)+5;if(al>mal)err(3);const sz=1<<al;let probs=sz,sym=-1,re=-1,i=-1,ht=sz;const buf=new ab(512+(sz<<2));const freq=new i16(buf,0,256);const dstate=new u16(buf,0,256);const nstate=new u16(buf,512,sz);const bb1=512+(sz<<1);const syms=new u8(buf,bb1,sz);const nbits=new u8(buf,bb1+sz);while(sym<255&&probs>0){const bits=msb(probs+1);const cbt=tpos>>3;const msk=(1<<bits+1)-1;let val=(dat[cbt]|dat[cbt+1]<<8|dat[cbt+2]<<16)>>(tpos&7)&msk;const msk1fb=(1<<bits)-1;const msv=msk-probs-1;const sval=val&msk1fb;if(sval<msv)tpos+=bits,val=sval;else{tpos+=bits+1;if(val>msk1fb)val-=msv}freq[++sym]=--val;if(val==-1){probs+=val;syms[--ht]=sym}else probs-=val;if(!val){do{const rbt=tpos>>3;re=(dat[rbt]|dat[rbt+1]<<8)>>(tpos&7)&3;tpos+=2;sym+=re}while(re==3)}}if(sym>255||probs)err(0);let sympos=0;const sstep=(sz>>1)+(sz>>3)+3;const smask=sz-1;for(let s=0;s<=sym;++s){const sf=freq[s];if(sf<1){dstate[s]=-sf;continue}for(i=0;i<sf;++i){syms[sympos]=s;do{sympos=sympos+sstep&smask}while(sympos>=ht)}}if(sympos)err(0);for(i=0;i<sz;++i){const ns=dstate[syms[i]]++;const nb=nbits[i]=al-msb(ns);nstate[i]=(ns<<nb)-sz}return[tpos+7>>3,{b:al,s:syms,n:nbits,t:nstate}]};var rhu=(dat,bt)=>{let i=0,wc=-1;const buf=new u8(292),hb=dat[bt];const hw=buf.subarray(0,256);const rc=buf.subarray(256,268);const ri=new u16(buf.buffer,268);if(hb<128){const[ebt,fdt]=rfse(dat,bt+1,6);bt+=hb;const epos=ebt<<3;const lb=dat[bt];if(!lb)err(0);let st1=0,st2=0,btr1=fdt.b,btr2=btr1;let fpos=(++bt<<3)-8+msb(lb);for(;;){fpos-=btr1;if(fpos<epos)break;let cbt=fpos>>3;st1+=(dat[cbt]|dat[cbt+1]<<8)>>(fpos&7)&(1<<btr1)-1;hw[++wc]=fdt.s[st1];fpos-=btr2;if(fpos<epos)break;cbt=fpos>>3;st2+=(dat[cbt]|dat[cbt+1]<<8)>>(fpos&7)&(1<<btr2)-1;hw[++wc]=fdt.s[st2];btr1=fdt.n[st1];st1=fdt.t[st1];btr2=fdt.n[st2];st2=fdt.t[st2]}if(++wc>255)err(0)}else{wc=hb-127;for(;i<wc;i+=2){const byte=dat[++bt];hw[i]=byte>>4;hw[i+1]=byte&15}++bt}let wes=0;for(i=0;i<wc;++i){const wt=hw[i];if(wt>11)err(0);wes+=wt&&1<<wt-1}const mb=msb(wes)+1;const ts=1<<mb;const rem=ts-wes;if(rem&rem-1)err(0);hw[wc++]=msb(rem)+1;for(i=0;i<wc;++i){const wt=hw[i];++rc[hw[i]=wt&&mb+1-wt]}const hbuf=new u8(ts<<1);const syms=hbuf.subarray(0,ts),nb=hbuf.subarray(ts);ri[mb]=0;for(i=mb;i>0;--i){const pv=ri[i];fill(nb,i,pv,ri[i-1]=pv+rc[i]*(1<<mb-i))}if(ri[0]!=ts)err(0);for(i=0;i<wc;++i){const bits=hw[i];if(bits){const code=ri[bits];fill(syms,i,code,ri[bits]=code+(1<<mb-bits))}}return[bt,{n:nb,b:mb,s:syms}]};var dllt=rfse(new u8([81,16,99,140,49,198,24,99,12,33,196,24,99,102,102,134,70,146,4]),0,6)[1];var dmlt=rfse(new u8([33,20,196,24,99,140,33,132,16,66,8,33,132,16,66,8,33,68,68,68,68,68,68,68,68,36,9]),0,6)[1];var doct=rfse(new u8([32,132,16,66,102,70,68,68,68,68,36,73,2]),0,5)[1];var b2bl=(b,s)=>{const len=b.length,bl=new i32(len);for(let i=0;i<len;++i){bl[i]=s;s+=1<<b[i]}return bl};var llb=new u8(new i32([0,0,0,0,16843009,50528770,134678020,202050057,269422093]).buffer,0,36);var llbl=b2bl(llb,0);var mlb=new u8(new i32([0,0,0,0,0,0,0,0,16843009,50528770,117769220,185207048,252579084,16]).buffer,0,53);var mlbl=b2bl(mlb,3);var dhu=(dat,out,hu)=>{const len=dat.length,ss=out.length,lb=dat[len-1],msk=(1<<hu.b)-1,eb=-hu.b;if(!lb)err(0);let st=0,btr=hu.b,pos=(len<<3)-8+msb(lb)-btr,i=-1;for(;pos>eb&&i<ss;){const cbt=pos>>3;const val=(dat[cbt]|dat[cbt+1]<<8|dat[cbt+2]<<16)>>(pos&7);st=(st<<btr|val)&msk;out[++i]=hu.s[st];pos-=btr=hu.n[st]}if(pos!=eb||i+1!=ss)err(0)};var dhu4=(dat,out,hu)=>{let bt=6;const ss=out.length,sz1=ss+3>>2,sz2=sz1<<1,sz3=sz1+sz2;dhu(dat.subarray(bt,bt+=dat[0]|dat[1]<<8),out.subarray(0,sz1),hu);dhu(dat.subarray(bt,bt+=dat[2]|dat[3]<<8),out.subarray(sz1,sz2),hu);dhu(dat.subarray(bt,bt+=dat[4]|dat[5]<<8),out.subarray(sz2,sz3),hu);dhu(dat.subarray(bt),out.subarray(sz3),hu)};var rzb=(dat,st,out)=>{let bt=st.b;const b0=dat[bt],btype=b0>>1&3;st.l=b0&1;const sz=b0>>3|dat[bt+1]<<5|dat[bt+2]<<13;const ebt=(bt+=3)+sz;if(btype==1){if(bt>=dat.length)return;st.b=bt+1;if(out){fill(out,dat[bt],st.y,st.y+=sz);return out}return fill(new u8(sz),dat[bt])}if(ebt>dat.length)return;if(btype==0){st.b=ebt;if(out){out.set(dat.subarray(bt,ebt),st.y);st.y+=sz;return out}return slc(dat,bt,ebt)}if(btype==2){const b3=dat[bt],lbt=b3&3,sf=b3>>2&3;let lss=b3>>4,lcs=0,s4=0;if(lbt<2){if(sf&1)lss|=dat[++bt]<<4|(sf&2&&dat[++bt]<<12);else lss=b3>>3}else{s4=sf;if(sf<2)lss|=(dat[++bt]&63)<<4,lcs=dat[bt]>>6|dat[++bt]<<2;else if(sf==2)lss|=dat[++bt]<<4|(dat[++bt]&3)<<12,lcs=dat[bt]>>2|dat[++bt]<<6;else lss|=dat[++bt]<<4|(dat[++bt]&63)<<12,lcs=dat[bt]>>6|dat[++bt]<<2|dat[++bt]<<10}++bt;let buf=out?out.subarray(st.y,st.y+st.m):new u8(st.m);let spl=buf.length-lss;if(lbt==0)buf.set(dat.subarray(bt,bt+=lss),spl);else if(lbt==1)fill(buf,dat[bt++],spl);else{let hu=st.h;if(lbt==2){const hud=rhu(dat,bt);lcs+=bt-(bt=hud[0]);st.h=hu=hud[1]}else if(!hu)err(0);(s4?dhu4:dhu)(dat.subarray(bt,bt+=lcs),buf.subarray(spl),hu)}let ns=dat[bt++];if(ns){if(ns==255)ns=(dat[bt++]|dat[bt++]<<8)+32512;else if(ns>127)ns=ns-128<<8|dat[bt++];const scm=dat[bt++];if(scm&3)err(0);const dts=[dmlt,doct,dllt];for(let i=2;i>-1;--i){const md=scm>>(i<<1)+2&3;if(md==1){const rbuf=new u8([0,0,dat[bt++]]);dts[i]={s:rbuf.subarray(2,3),n:rbuf.subarray(0,1),t:new u16(rbuf.buffer,0,1),b:0}}else if(md==2){[bt,dts[i]]=rfse(dat,bt,9-(i&1))}else if(md==3){if(!st.t)err(0);dts[i]=st.t[i]}}const[mlt,oct,llt]=st.t=dts;const lb=dat[ebt-1];if(!lb)err(0);let spos=(ebt<<3)-8+msb(lb)-llt.b,cbt=spos>>3,oubt=0;let lst=(dat[cbt]|dat[cbt+1]<<8)>>(spos&7)&(1<<llt.b)-1;cbt=(spos-=oct.b)>>3;let ost=(dat[cbt]|dat[cbt+1]<<8)>>(spos&7)&(1<<oct.b)-1;cbt=(spos-=mlt.b)>>3;let mst=(dat[cbt]|dat[cbt+1]<<8)>>(spos&7)&(1<<mlt.b)-1;for(++ns;--ns;){const llc=llt.s[lst];const lbtr=llt.n[lst];const mlc=mlt.s[mst];const mbtr=mlt.n[mst];const ofc=oct.s[ost];const obtr=oct.n[ost];cbt=(spos-=ofc)>>3;const ofp=1<<ofc;let off=ofp+((dat[cbt]|dat[cbt+1]<<8|dat[cbt+2]<<16|dat[cbt+3]<<24)>>>(spos&7)&ofp-1);cbt=(spos-=mlb[mlc])>>3;let ml=mlbl[mlc]+((dat[cbt]|dat[cbt+1]<<8|dat[cbt+2]<<16)>>(spos&7)&(1<<mlb[mlc])-1);cbt=(spos-=llb[llc])>>3;const ll=llbl[llc]+((dat[cbt]|dat[cbt+1]<<8|dat[cbt+2]<<16)>>(spos&7)&(1<<llb[llc])-1);cbt=(spos-=lbtr)>>3;lst=llt.t[lst]+((dat[cbt]|dat[cbt+1]<<8)>>(spos&7)&(1<<lbtr)-1);cbt=(spos-=mbtr)>>3;mst=mlt.t[mst]+((dat[cbt]|dat[cbt+1]<<8)>>(spos&7)&(1<<mbtr)-1);cbt=(spos-=obtr)>>3;ost=oct.t[ost]+((dat[cbt]|dat[cbt+1]<<8)>>(spos&7)&(1<<obtr)-1);if(off>3){st.o[2]=st.o[1];st.o[1]=st.o[0];st.o[0]=off-=3}else{const idx=off-(ll!=0);if(idx){off=idx==3?st.o[0]-1:st.o[idx];if(idx>1)st.o[2]=st.o[1];st.o[1]=st.o[0];st.o[0]=off}else off=st.o[0]}for(let i=0;i<ll;++i){buf[oubt+i]=buf[spl+i]}oubt+=ll,spl+=ll;let stin=oubt-off;if(stin<0){let len=-stin;const bs=st.e+stin;if(len>ml)len=ml;for(let i=0;i<len;++i){buf[oubt+i]=st.w[bs+i]}oubt+=len,ml-=len,stin=0}for(let i=0;i<ml;++i){buf[oubt+i]=buf[stin+i]}oubt+=ml}if(oubt!=spl){while(spl<buf.length){buf[oubt++]=buf[spl++]}}else oubt=buf.length;if(out)st.y+=oubt;else buf=slc(buf,0,oubt)}else if(out){st.y+=lss;if(spl){for(let i=0;i<lss;++i){buf[i]=buf[spl+i]}}}else if(spl)buf=slc(buf,spl);st.b=ebt;return buf}err(2)};var cct=(bufs,ol)=>{if(bufs.length==1)return bufs[0];const buf=new u8(ol);for(let i=0,b=0;i<bufs.length;++i){const chk=bufs[i];buf.set(chk,b);b+=chk.length}return buf};function decompress(dat,buf){const bufs=[],nb=+!buf;let bt=0,ol=0;for(;dat.length;){const st=rzfh(dat,nb||buf);if(typeof st=="object"){if(nb){buf=null;if(st.w.length==st.u){bufs.push(buf=st.w);ol+=st.u}}else{bufs.push(buf);st.e=0}for(;!st.l;){const blk=rzb(dat,st,buf);if(!blk)err(5);if(buf)st.e=st.y;else{bufs.push(blk);ol+=blk.length;cpw(st.w,0,blk.length);st.w.set(blk,st.w.length-blk.length)}}bt=st.b+st.c*4}else bt=st;dat=dat.subarray(bt)}return cct(bufs,ol)}var EmbeddedFileParser=class extends ParserBase{parse(sectionContent){let sections=Sections.getSections(sectionContent.substring(1,sectionContent.length-1));for(let section of sections){let properties=Sections.getProperties(section);if(properties.type=="worksheet"){this.designElement=new WorksheetElement("worksheet");this.designElement.filename=properties.name[0];this.designElement.content=properties.data.join("").replace(/^\|+|\|+$/g,"");this.designElement.content=atob(this.designElement.content);let contentArray=new Uint8Array(this.designElement.content.length);for(let i=0;i<this.designElement.content.length;i++){contentArray[i]=this.designElement.content.charCodeAt(i)}contentArray=decompress(contentArray);this.designElement.content="";for(let i=0;i<contentArray.length;i++){this.designElement.content+=String.fromCharCode(contentArray[i])}}}}};var Junction=class extends GraphicsBase{drawElement(ctx){ctx.beginPath();ctx.arc(this.points[0].x,this.points[0].y,this.size/2,0,Math.PI*2);ctx.fillStyle=this.color;ctx.fill()}};var JunctionParser=class extends ParserBase{parse(sectionContent){let properties=Sections.getProperties(sectionContent);let junction=new Junction;junction.layer="design";junction.points.push({x:parseFloat(properties.at[0]),y:parseFloat(properties.at[1])});junction.size=parseFloat(properties.diameter[0]);junction.color=properties.color.map(x=>parseInt(x,10));junction.color=this.getColor("junction",junction.color);this.graphicsElements.push(junction)}};var LayersElement=class extends DesignElement{constructor(reference){super(reference);this.copperLayers=[]}};var LayersParser=class extends ParserBase{parse(sectionContent){let layers={};let properties=Sections.getProperties(sectionContent);for(let prop in properties){const layer=properties[prop][0];let index=LAYER_ORDER.indexOf(layer)*100;if(layer.startsWith("In")&&layer.endsWith(".Cu")){index=(LAYER_ORDER.indexOf("In*")+1)*100;const match=layer.match(/In(\d+).Cu/);index-=parseInt(match[1])}if(index<0){logger.warn(logger.LEVEL_PARSER,"[Parser] unknown layer:",layer)}else{layers[index]=layer}}this.designElement=new LayersElement("layers");this.designElement.layers=Object.values(layers)}};var LAYER_ORDER=["B.SilkS","B.CrtYd","B.Fab","B.Adhes","B.Paste","B.Cu","B.Mask","In*","F.Mask","F.Cu","F.Paste","F.Adhes","F.Fab","F.CrtYd","F.SilkS","Margin","Edge.Cuts","Dwgs.User","Cmts.User","Eco1.User","Eco2.User"];var LineParser=class extends ParserBase{parse(sectionContent){const properties=Sections.getProperties(sectionContent);let startX=0;let startY=0;let endX=0;let endY=0;if(properties.start){startX=this.correctXY("x",parseFloat(properties.start[0]),properties.start?.[2]??null);startY=this.correctXY("y",parseFloat(properties.start[1]),properties.start?.[2]??null)}if(properties.end){endX=this.correctXY("x",parseFloat(properties.end[0]),properties.end?.[2]??null);endY=this.correctXY("y",parseFloat(properties.end[1]),properties.end?.[2]??null)}if(properties.pts){startX=parseFloat(properties.pts[0].split(" ")[1]);startY=parseFloat(properties.pts[0].split(" ")[2]);endX=parseFloat(properties.pts[1].split(" ")[1]);endY=parseFloat(properties.pts[1].split(" ")[2])}let repeat=parseInt(properties.repeat?.[0]??1);let incrX=parseInt(properties.incrx?.[0]??0);let incrY=parseInt(properties.incry?.[0]??0);let layer=properties.layer?.[0]??"design";let color=this.sectionName=="segment"?this.getColor(layer):this.getColor(this.sectionName);if(this.designType=="kicad_wks"){layer="sheet";color=this.getColor("worksheet")}let size=properties.width?parseFloat(properties.width[0]):0;if(properties.stroke){let parts=properties.stroke[0].split(" ");size=parts[0]=="width"?parseFloat(parts[1]):0}size=this.getLineThickness(size);let minX=this.paper?0:-2e3;let minY=this.paper?0:-2e3;let maxX=this.paper?this.paper.width:2e3;let maxY=this.paper?this.paper.height:2e3;minX+=this.setup?this.setup.leftMargin:0;minY+=this.setup?this.setup.topMargin:0;maxX-=this.setup?this.setup.rightMargin:0;maxY-=this.setup?this.setup.bottomMargin:0;for(let i=0;i<repeat;i++){let xs=startX+i*incrX;let ys=startY+i*incrY;let xe=endX+i*incrX;let ye=endY+i*incrY;if(xs>=minX&&xs<=maxX&&ys>=minY&&ys<=maxY&&xe>=minX&&xe<=maxX&&ye>=minY&&ye<=maxY){let line=new Line;line.layer=layer;line.color=color;line.size=size;line.points.push({x:xs,y:ys});line.points.push({x:xe,y:ye});this.graphicsElements.push(line)}}}};var Rectangle=class extends GraphicsBase{drawElement(ctx){ctx.strokeStyle=this.color;ctx.lineWidth=this.size;if(this.scaledSize){ctx.lineWidth/=this.scale}const w=this.points[1].x-this.points[0].x;const h=this.points[1].y-this.points[0].y;ctx.strokeRect(this.points[0].x,this.points[0].y,w,h)}};var PaperElement=class extends DesignElement{constructor(reference){super(reference);this.width=0;this.height=0}};var PaperParser=class extends ParserBase{parse(sectionContent){let values=Sections.getValues(sectionContent);let pageSize=paperSizes[values[0]];let isPortrait=false;if(values.length>1){isPortrait=values[1]=="portrait"}if(!pageSize){logger.warn(logger.LEVEL_PARSER,"Unknown page size:",values[0]);pageSize=paperSizes.A4}this.keyValueMap.set("paper",values[0]);this.designElement=new PaperElement("paper");if(isPortrait){this.designElement.width=pageSize.height;this.designElement.height=pageSize.width}else{this.designElement.width=pageSize.width;this.designElement.height=pageSize.height}let rectangle=new Rectangle;rectangle.layer="sheet";rectangle.color=this.getColor("page_limits");rectangle.size=.5;rectangle.scaledSize=true;rectangle.points.push({x:0,y:0});rectangle.points.push({x:this.designElement.width,y:this.designElement.height});this.graphicsElements.push(rectangle)}};var paperSizes={A0:{width:1189,height:841},A1:{width:841,height:594},A2:{width:594,height:420},A3:{width:420,height:297},A4:{width:297,height:210}};var RectangleParser=class extends ParserBase{parse(sectionContent){const properties=Sections.getProperties(sectionContent);const startX=this.correctXY("x",parseFloat(properties.start[0]),properties.start?.[2]??null);const startY=this.correctXY("y",parseFloat(properties.start[1]),properties.start?.[2]??null);const endX=this.correctXY("x",parseFloat(properties.end[0]),properties.end?.[2]??null);const endY=this.correctXY("y",parseFloat(properties.end[1]),properties.end?.[2]??null);const repeat=parseInt(properties.repeat?.[0]??1);const incrX=parseInt(properties.incrx?.[0]??0);const incrY=parseInt(properties.incry?.[0]??0);const color=this.getColor("worksheet");const size=this.getLineThickness();for(let i=0;i<repeat;i++){let xs=startX+i*incrX;let ys=startY+i*incrY;let xe=endX-i*incrX;let ye=endY-i*incrY;let rectangle=new Rectangle;rectangle.layer="sheet";rectangle.color=color;rectangle.size=size;rectangle.points.push({x:xs,y:ys});rectangle.points.push({x:xe,y:ye});this.graphicsElements.push(rectangle)}}};var SetupElement=class extends DesignElement{constructor(reference){super(reference);this.textSize=0;this.lineWidth=0;this.leftMargin=10;this.rightMargin=10;this.topMargin=10;this.bottomMargin=10}};var SetupParser=class extends ParserBase{parse(sectionContent){let properties=Sections.getProperties(sectionContent,true);this.designElement=new SetupElement(this.sectionName);this.designElement.textSize=properties.textsize?parseFloat(properties.textsize):0;this.designElement.lineWidth=properties.linewidth?parseFloat(properties.linewidth):0;this.designElement.leftMargin=properties.left_margin?parseFloat(properties.left_margin):0;this.designElement.rightMargin=properties.right_margin?parseFloat(properties.right_margin):0;this.designElement.topMargin=properties.top_margin?parseFloat(properties.top_margin):0;this.designElement.bottomMargin=properties.bottom_margin?parseFloat(properties.bottom_margin):0}};var Text=class extends GraphicsBase{drawElement(ctx){ctx.font=this.font;ctx.fillStyle=this.color;ctx.textAlign=this.align_h;ctx.textBaseline=this.align_v;ctx.fillText(this.text,this.points[0].x,this.points[0].y)}};var TextParser=class extends ParserBase{parse(sectionContent){const properties=Sections.getProperties(sectionContent);let content=this.keyValueMap.replace(Sections.getValues(sectionContent)[0]);let size=this.getTextSize();let bold=false;let italic=false;let align_h="left";let align_v="middle";let mirror=false;if(properties.font){for(let value of properties.font){if(value=="bold")bold=true;if(value=="italic")italic=true;if(value.startsWith("size ")){size=value.split(" ")[1]}}}if(properties.justify){for(let value of properties.justify){if(["left","center","right"].includes(value)){align_h=value}if(["top","middle","bottom"].includes(value)){align_v=value}if(value=="mirror"){mirror=true}}}const x=this.correctXY("x",parseFloat(properties.pos[0]),properties.pos?.[2]??null);let y=this.correctXY("y",parseFloat(properties.pos[1]),properties.pos?.[2]??null);y+=size*.15;const repeat=parseInt(properties.repeat?.[0]??1);const incrX=parseInt(properties.incrx?.[0]??0);const incrY=parseInt(properties.incry?.[0]??0);const color=this.getColor("worksheet");let font="";font+=bold?"bold ":"";font+=italic?"italic ":"";font+=`${size}px `;font+="KiCadFont";let minX=0;let minY=0;let maxX=this.paper.width;let maxY=this.paper.height;minX+=this.setup.leftMargin||0;minY+=this.setup.topMargin||0;maxX-=this.setup.rightMargin||0;maxY-=this.setup.bottomMargin||0;for(let i=0;i<repeat;i++){let xs=x+i*incrX;let ys=y+i*incrY;if(xs>=minX&&xs<=maxX&&ys>=minY&&ys<=maxY){let text=new Text;text.font=font;text.text=content;text.layer="sheet";text.color=color;text.align_h=align_h;text.align_v=align_v;text.mirror=mirror;text.points.push({x:xs,y:ys});this.graphicsElements.push(text);if(repeat>1){content=this.nextTextSequence(content)}}}}};var TitleBlockElement=class extends DesignElement{constructor(reference){super(reference);this.comment1="";this.comment2="";this.comment3="";this.comment4="";this.company="";this.date="";this.kicad_version="";this.revision="";this.title=""}};var TitleBlockParser=class extends ParserBase{parse(sectionContent){const titleBlock=new TitleBlockElement("title_block");const properties=Sections.getProperties(sectionContent,true);for(let prop in properties){switch(prop){case"comment1":titleBlock.comment1=properties[prop];this.keyValueMap.set("comment1",titleBlock.comment1);break;case"comment2":titleBlock.comment2=properties[prop];this.keyValueMap.set("comment2",titleBlock.comment2);break;case"comment3":titleBlock.comment3=properties[prop];this.keyValueMap.set("comment3",titleBlock.comment3);break;case"comment4":titleBlock.comment4=properties[prop];this.keyValueMap.set("comment4",titleBlock.comment4);break;case"company":titleBlock.company=properties[prop];this.keyValueMap.set("company",titleBlock.company);break;case"date":titleBlock.date=properties[prop];this.keyValueMap.set("issue_date",titleBlock.date);break;case"kicad_version":titleBlock.kicad_version=properties[prop];this.keyValueMap.set("kicad_version",titleBlock.kicad_version);break;case"rev":titleBlock.revision=properties[prop];this.keyValueMap.set("revision",titleBlock.revision);break;case"title":titleBlock.title=properties[prop];this.keyValueMap.set("title",titleBlock.title);break}}}};var Polygon=class extends GraphicsBase{drawElement(ctx){ctx.fillStyle=this.color;ctx.lineWidth=0;ctx.beginPath();ctx.moveTo(this.points[0].x,this.points[0].y);for(let i=1;i<this.points.length;i++){ctx.lineTo(this.points[i].x,this.points[i].y)}ctx.closePath();ctx.fill()}};var ZoneParser=class extends ParserBase{parse(sectionContent){let sections=Sections.getSections(sectionContent.substring(1,sectionContent.length-1));for(const subSection of sections){let name=Sections.getSectionName(subSection);switch(name){case"filled_polygon":let props=Sections.getProperties(subSection);let polygon=new Polygon;polygon.layer=props.layer[0];polygon.color=this.getColor(polygon.layer);for(let pt of props.pts){let parts=pt.split(" ");if(parts.length==3&&parts[0]=="xy"){polygon.points.push({x:parseFloat(parts[1]),y:parseFloat(parts[2])})}}this.graphicsElements.push(polygon);break;case"attr":case"connect_pads":case"fill":case"filled_areas_thickness":case"hatch":case"layer":case"min_thickness":case"name":case"net":case"net_name":case"polygon":case"priority":case"uuid":break;default:logger.warn(logger.LEVEL_PARSER,"[ZoneParser]: unknown zone subsection:",name)}}}};var DesignParser={parseFile:async function(src,filename){let design=null;timer.start("Parse design");logger.info(logger.LEVEL_PARSER,"[Parser] Fetching file content");const content=await fetchFile(src);if(content){logger.info(logger.LEVEL_PARSER,`[Parser] Content length: ${content.length} bytes`);logger.info(logger.LEVEL_PARSER,`[Parser] Parsing file: '${filename}'`);const keyValueMap=new KeyValueMap;keyValueMap.set("filename",filename);design=this.parseContent(content,keyValueMap);design.filename=filename;keyValueMap.set("#",1);keyValueMap.set("##",1);let pageLayout=PAGE_LAYOUT;let worksheet=design.getDesignElement("worksheet");if(worksheet){pageLayout=worksheet.content}pageLayout=this.parseContent(pageLayout,keyValueMap,design.designType,design.getDesignElement("paper"));design.designElements.push(...pageLayout.designElements);design.graphicsElements.push(...pageLayout.graphicsElements);logger.info(logger.LEVEL_PARSER,`[Parser] Parsed design: ${design.designType} ${design.designElements.length} design elements, ${design.graphicsElements.length} graphic elements`)}timer.stop("Parse design");return design},parseContent:function(content,keyValueMap,parentType=null,paper=null){timer.start("Parse content");let design=new DesignObject;let sections=Sections.getSections(content);if(sections.length!=1){logger.error(logger.LEVEL_SYSTEM,"[Parser] Invalid file format.")}else{design.designType=Sections.getSectionName(sections[0]);logger.info(logger.LEVEL_PARSER,`[Parser] Design type: '${design.designType}'`);for(let section of Sections.getSections(sections[0].substring(1,sections[0].length-1))){let elementParser=null;let sectionName=Sections.getSectionName(section);switch(sectionName){case"bus_entry":elementParser=new BusEntryParser;break;case"embedded_files":elementParser=new EmbeddedFileParser;break;case"generator_version":design.version=Sections.getValues(section)[0];break;case"junction":elementParser=new JunctionParser;break;case"layers":elementParser=new LayersParser;break;case"bus":case"line":case"segment":case"wire":elementParser=new LineParser;break;case"paper":elementParser=new PaperParser;break;case"rect":elementParser=new RectangleParser;break;case"setup":elementParser=new SetupParser;break;case"tbtext":elementParser=new TextParser;break;case"title_block":elementParser=new TitleBlockParser;break;case"zone":elementParser=new ZoneParser;break;case"embedded_fonts":case"generator":case"net":case"uuid":case"version":break;default:logger.warn(logger.LEVEL_PARSER,"[Parser] Unknown section:",sectionName);break}if(elementParser!=null){keyValueMap;elementParser.parseSection(section,design.designType,parentType,design.getDesignElement("setup"),paper,keyValueMap);design.designElements.push(elementParser.designElement);design.graphicsElements.push(...elementParser.graphicsElements)}}}timer.stop("Parse content");return design}};var Drawer={draw:function(ctx,designObject,scale){let layerOrder=["sheet"];let layers=designObject.getDesignElement("layers");if(layers){layerOrder.push(...layers.layers)}layerOrder.push("design");let drawnLayers=[];timer.start("Drawer");logger.info(logger.LEVEL_DRAWER,`[Drawer] drawing '${designObject.filename}'`,designObject.designType);const byLayer=designObject.graphicsElements.reduce((acc,obj)=>{(acc[obj.layer]??=[]).push(obj);return acc},{});for(const layer of layerOrder){if(byLayer[layer]){if(byLayer[layer].length>0){logger.info(logger.LEVEL_DRAWER,`[Drawer] drawing layer '${layer}'`);logger.info(logger.LEVEL_DRAWER,`[Drawer] drawing ${byLayer[layer].length} elements`);for(const element of byLayer[layer]){element.scale=scale;element.draw(ctx)}drawnLayers.push(layer)}}}logger.info(logger.LEVEL_DRAWER,"[Drawer] drawn layers: "+drawnLayers.join(", "));const undrawn=Object.keys(byLayer).filter(layer=>!drawnLayers.includes(layer));if(undrawn.length>0)logger.warn(logger.LEVEL_DRAWER,"[Drawer] undrawn layers: "+undrawn.join(", "));timer.stop("Drawer")}};var KiViewer=class{constructor(canvas){logger.setLogElement("logOutput");const userSettings=typeof kiViewerSettings!=="undefined"?kiViewerSettings:{};logger.logLevel|=userSettings.logLevel||0;this.canvas=canvas;this.design=null;this.viewportTransform={x:0,y:0,scale:1};this.fitScaleX=1;this.fitScaleY=1;this.scaleSpeed=1/250;this.minScale=1/50;this.previousX=0;this.previousY=0;this.isMoving=false;this.canvas.addEventListener("mousedown",this._onMouseDown.bind(this));this.canvas.addEventListener("mouseup",this._onMouseUp.bind(this));this.canvas.addEventListener("mousemove",this._onMouseMove.bind(this));this.canvas.addEventListener("wheel",this._onMouseWheel.bind(this));timer.reset()}async initialize(){timer.start("Viewer");let canvasSrc=this.canvas.getAttribute("src");let filename=this.canvas.getAttribute("filename");logger.info(logger.LEVEL_VIEWER,`[Viewer] viewing file '${filename}'`);this.design=await DesignParser.parseFile(canvasSrc,filename);if(this.design){let page=this.design.getDesignElement("paper");this.fitScaleX=this.canvas.width/page.width;this.fitScaleY=this.canvas.height/page.height;this.viewportTransform.scale=Math.min(this.fitScaleX,this.fitScaleY)*.98;this.viewportTransform.x=(this.canvas.width-page.width*this.viewportTransform.scale)/2;this.viewportTransform.y=(this.canvas.height-page.height*this.viewportTransform.scale)/2;this._render()}timer.stop("Viewer");timer.showReport()}_render(){timer.start("Render");const ctx=this.canvas.getContext("2d");ctx.globalCompositeOperation="source-over";ctx.setTransform(1,0,0,1,0,0);ctx.clearRect(0,0,this.canvas.width,this.canvas.height);ctx.fillStyle=Colors[this.design.designType]["background"];ctx.fillRect(0,0,this.canvas.width,this.canvas.height);let scaleRatioX=this.viewportTransform.scale/this.fitScaleX;let scaleRatioY=this.viewportTransform.scale/this.fitScaleY;let maxX=this.canvas.width*.95;let minX=-this.canvas.width*.95;let maxY=this.canvas.height*.95;let minY=-this.canvas.height*.95;this.viewportTransform.x=this.viewportTransform.x>maxX?maxX:this.viewportTransform.x;this.viewportTransform.x=this.viewportTransform.x/scaleRatioX<minX?minX*scaleRatioX:this.viewportTransform.x;this.viewportTransform.y=this.viewportTransform.y>maxY?maxY:this.viewportTransform.y;this.viewportTransform.y=this.viewportTransform.y/scaleRatioY<minY?minY*scaleRatioY:this.viewportTransform.y;ctx.setTransform(this.viewportTransform.scale,0,0,this.viewportTransform.scale,this.viewportTransform.x,this.viewportTransform.y);Drawer.draw(ctx,this.design,this.viewportTransform.scale);timer.stop("Render")}_onMouseDown(e){if(logger.logLevel&logger.LEVEL_EVENTS)console.log(e);this.previousX=e.clientX;this.previousY=e.clientY;this.isMoving=true}_onMouseUp(e){if(logger.logLevel&logger.LEVEL_EVENTS)console.log(e);this.isMoving=false}_onMouseMove(e){if(!this.isMoving)return;if(logger.logLevel&logger.LEVEL_EVENTS)console.log(e);const localX=e.clientX;const localY=e.clientY;this.viewportTransform.x+=localX-this.previousX;this.viewportTransform.y+=localY-this.previousY;this.previousX=localX;this.previousY=localY;this._render()}_onMouseWheel(e){if(logger.logLevel&logger.LEVEL_EVENTS)console.log(e);e.preventDefault();const oldX=this.viewportTransform.x;const oldY=this.viewportTransform.y;const localX=e.clientX;const localY=e.clientY;const previousScale=this.viewportTransform.scale;this.viewportTransform.scale+=e.deltaY*-this.scaleSpeed;if(this.viewportTransform.scale<this.minScale){this.viewportTransform.scale=this.minScale}this.viewportTransform.x=localX-(localX-oldX)*(this.viewportTransform.scale/previousScale);this.viewportTransform.y=localY-(localY-oldY)*(this.viewportTransform.scale/previousScale);this._render()}};document.addEventListener("DOMContentLoaded",async function(){const font=new FontFace("KiCadFont",KI_FONT.buffer);font.load().then(function(loadedFont){document.fonts.add(loadedFont)});for(const canvas of document.querySelectorAll('canvas[type="application/kicad"]')){const viewer=new KiViewer(canvas);await viewer.initialize()}});})();
